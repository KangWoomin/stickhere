{% extends "base.html" %}

{% block title %}홈{% endblock %}

{% block content %}
<main class="container">
    <section id="videos">
        <h2>추천 영상</h2>
        <div class="video-container">
            {% for video in shorts %}
                <div class="video-item">
                    <video controls width="350" height="500">
                        <source src="{{video.video.url}}" type="video/mp4">
                        당신의 브라우저는 동영상을 지원하지 않습니다.
                    </video>
                    <p><a href="{% url 'shorts_board_detail' video.pk%}">{{ video.title }}</a></p>
                </div>
            {% endfor %}
        </div>
    </section>
    
    {% if user.is_authenticated %}
        <a href="{% url 'board_type' %}" class="btn btn-primary">
            새 게시물 등록
        </a>
    {% endif %}

    <section id="posts">
        <h2>게시물</h2>
        {% for video in shorts %}
        <article class="post-item" style="width: 100%;">
            <h3><a href="{% url 'shorts_board_detail' video.pk%}">{{ video.title }}</a></h3>
            <p>{{ video.content }}</p>
            {% if video.video %}
                <video controls width="320" class="post-video">
                    <source src="{{video.video.url}}" type="video/mp4">
                    당신의 브라우저는 동영상을 지원하지 않습니다.
                </video>
            {% endif %}
            <p>조회수: {{ post.views }} | 추천수: <span id="likes-{{ post.id }}">{{ post.likes }}</span></p>
            <button id="like-button-{{ post.id }}" onclick="likePost('{{ post.id }}')" class="btn btn-primary">좋아요</button>
        </article>
   
        
    {% endfor %}
        {% for text in texts %}
            <article class="post-item" style="width: 100%;">
                <h3><a href="{% url 'text_detail' text.pk%}">{{ text.title }}</a></h3>
                
                {% if text.content %}
                    <p>{{text.content}}</p>
                {% endif %}
                <p>조회수: {{ post.views }} | 추천수: <span id="likes-{{ post.id }}">{{ post.likes }}</span></p>
                <button id="like-button-{{ post.id }}" onclick="likePost('{{ post.id }}')" class="btn btn-primary">좋아요</button>
            </article>
       
            
        {% endfor %}
    </section>
</main>

<style>
    .video-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-top: 20px;
    }

    .video-item {
        flex: 1;
        max-width: 45%;
        box-sizing: border-box;
    }

    .post-item {
        margin-bottom: 20px;
    }

    video {
        width: 100%;
        height: auto;
    }

    .btn {
        padding: 10px 20px;
        background-color: #f56c00;
        border: none;
        color: white;
        cursor: pointer;
        text-align: center;
        text-decoration: none;
    }

    .btn-primary {
        background-color: #f56c00;
    }

    .btn-primary:hover {
        background-color: #e65c00;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const postVideos = document.querySelectorAll('.post-video');
        let currentVideoIndex = 0;

        function playNextVideo() {
            if (currentVideoIndex >= postVideos.length) {
                return; // 모든 동영상을 재생한 경우 종료
            }
            // 현재 동영상 정지 및 다음 동영상으로 이동
            postVideos[currentVideoIndex].pause();
            currentVideoIndex++;
            if (currentVideoIndex < postVideos.length) {
                postVideos[currentVideoIndex].play();
                // 페이지를 다음 동영상으로 스크롤
                postVideos[currentVideoIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // 동영상의 ended 이벤트를 사용하여 다음 동영상 재생
        postVideos.forEach((player, index) => {
            player.addEventListener('ended', playNextVideo);
        });

        // 첫 번째 동영상 자동 재생
        if (postVideos.length > 0) {
            postVideos[currentVideoIndex].play();
            postVideos[currentVideoIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    });

    function likePost(postId) {
        fetch(`/like_post/${postId}`, {
            method: 'POST'
        }).then(response => response.json()).then(data => {
            if (data.success) {
                const likesSpan = document.getElementById(`likes-${postId}`);
                const likeButton = document.getElementById(`like-button-${postId}`);
                if (data.liked) {
                    likesSpan.textContent = parseInt(likesSpan.textContent) + 1;
                    likeButton.textContent = '좋아요 취소';
                } else {
                    likesSpan.textContent = parseInt(likesSpan.textContent) - 1;
                    likeButton.textContent = '좋아요';
                }
            }
        });
    }

    // 무한 스크롤 기능
    let page = 1;
    window.onscroll = function() {
        if (window.innerHeight + window.scrollY >= document.body.offsetHeight) {
            page++;
            loadMorePosts(page);
        }
    };

    function loadMorePosts(page) {
        fetch(`/load_more_posts?page=${page}`)
            .then(response => response.text())
            .then(html => {
                document.getElementById('posts').insertAdjacentHTML('beforeend', html);
            });
    }
</script>
{% endblock %}
